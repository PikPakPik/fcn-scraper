name: ğŸ“… Scrape FC Nantes Calendar

on:
  schedule:
    # ExÃ©cuter tous les jours Ã  8h00 UTC (9h00 ou 10h00 en France selon la saison)
    - cron: '0 8 * * *'
  # Permettre l'exÃ©cution manuelle
  workflow_dispatch:
  # ExÃ©cuter aussi sur push pour tester
  push:
    branches: [ main, master ]

jobs:
  scrape-calendar:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          # NÃ©cessaire pour pouvoir commit les changements
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸ“š Install dependencies
        run: pnpm install

      - name: ğŸˆ Scrape FC Nantes calendar
        run: pnpm run scrape

      - name: ğŸ“„ Check if calendar file was generated
        run: |
          if [ -f "calendrier-fcnantes.ics" ]; then
            echo "âœ… Calendar file generated successfully"
            ls -la calendrier-fcnantes.ics
          else
            echo "âŒ Calendar file not found"
            exit 1
          fi

      - name: ğŸ“Š Add metadata to calendar file
        run: |
          # Ajouter des informations de build au dÃ©but du fichier
          TEMP_FILE=$(mktemp)
          echo "# FC Nantes Calendar - GÃ©nÃ©rÃ© automatiquement" > "$TEMP_FILE"
          echo "# DerniÃ¨re mise Ã  jour: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$TEMP_FILE"
          echo "# Source: https://billetterie.fcnantes.com/fr/prochains-matchs/calendrier" >> "$TEMP_FILE"
          echo "# Repository: ${{ github.repository }}" >> "$TEMP_FILE"
          echo "" >> "$TEMP_FILE"
          cat calendrier-fcnantes.ics >> "$TEMP_FILE"
          mv "$TEMP_FILE" calendrier-fcnantes.ics

      - name: ğŸ“ Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ajouter le fichier .ics
          git add calendrier-fcnantes.ics
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "ğŸ“‹ Aucun changement dÃ©tectÃ© dans le calendrier"
          else
            echo "ğŸ”„ Mise Ã  jour du calendrier dÃ©tectÃ©e"
            git commit -m "ğŸˆ Mise Ã  jour automatique du calendrier FC Nantes - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "âœ… Calendrier mis Ã  jour et publiÃ©"
          fi

      - name: ğŸ“¤ Upload calendar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: fc-nantes-calendar
          path: calendrier-fcnantes.ics
          retention-days: 30 